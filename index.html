<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>CYBER WINTER STURM ALARM SCHWEIZ</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#eef2f6;
  padding:20px;
}
h1{text-align:center}

button{
  width:100%;
  padding:16px;
  font-size:1.1em;
  border:none;
  border-radius:12px;
  background:#2980b9;
  color:white;
  cursor:pointer;
}

.status{
  margin-top:20px;
  padding:20px;
  border-radius:14px;
  text-align:center;
  color:white;
  font-size:1.2em;
}

.green{background:#2ecc71}
.yellow{background:#f1c40f;color:black}
.orange{background:#e67e22}
.red{background:#e74c3c}

#countdown{
  margin-top:15px;
  font-size:1.1em;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>

<h1>CYBER WINTER STURM ALARM SCHWEIZ</h1>

<button id="startBtn">üîî Alarm aktivieren</button>

<div id="status" class="status green">
Noch keine Daten
</div>

<div id="countdown"></div>

<script>
let activated=false;
let lastLevel=null;
let preAlarmSent=false;
let dangerTime=null;

const alarm=new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
alarm.loop=true;

/* ===== AMPEL LOGIK ===== */
function getLevel(temp,snow){
  if(temp>=-5 && snow<2) return "green";
  if(temp<-5 && temp>=-10 || snow>=2) return "yellow";
  if(temp<-10 && temp>=-15 || snow>=5) return "orange";
  return "red";
}

/* ===== COUNTDOWN ===== */
function startCountdown(target){
  setInterval(()=>{
    const diff=target-Date.now();
    if(diff<=0){
      countdown.innerHTML="üö® GEFAHR BEGINNT JETZT!";
      return;
    }
    const h=Math.floor(diff/3600000);
    const m=Math.floor(diff%3600000/60000);
    const s=Math.floor(diff%60000/1000);
    countdown.innerHTML=`‚è≥ Zeit bis Gefahr: ${h}h ${m}m ${s}s`;

    if(diff<=7200000 && !preAlarmSent){
      preAlarmSent=true;
      alarm.play().catch(()=>{});
      navigator.vibrate?.([1000,500,1000,500,1000]);
      new Notification("‚ö†Ô∏è Wintersturm-Warnung",{
        body:"EXTREME GEFAHR in weniger als 2 Stunden!"
      });
    }
  },1000);
}

/* ===== WETTER ===== */
async function checkWeather(lat,lon){
  const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,snowfall,time&timezone=Europe/Zurich`;
  const res=await fetch(url);
  const data=await res.json();

  let minTemp=999;
  let snowSum=0;
  let danger=null;

  for(let i=0;i<28;i++){
    const t=data.hourly.temperature_2m[i];
    const s=data.hourly.snowfall[i];
    minTemp=Math.min(minTemp,t);
    snowSum+=s;

    if(!danger && getLevel(t,s)==="red"){
      danger=new Date(data.hourly.time[i]).getTime();
    }
  }

  const level=getLevel(minTemp,snowSum);
  updateUI(level,minTemp,snowSum);

  if(danger){
    dangerTime=danger;
    startCountdown(danger);
  }else{
    countdown.innerHTML="‚úÖ Keine Gefahr in den n√§chsten 28 Stunden";
    alarm.pause();
  }
}

/* ===== UI ===== */
function updateUI(level,temp,snow){
  status.className="status "+level;

  const text={
    green:"üü¢ Keine Gefahr",
    yellow:"üü° Erh√∂hte Gefahr",
    orange:"üü† Mittlere Gefahr",
    red:"üî¥ EXTREME GEFAHR ‚Äì NICHT RAUSGEHEN"
  };

  status.innerHTML=`
    ${text[level]}<br>
    Tiefsttemperatur: ${temp.toFixed(1)}¬∞C<br>
    Schnee: ${snow.toFixed(1)} cm
  `;

  if(level!==lastLevel){
    lastLevel=level;
    new Notification("Winterstatus Schweiz",{body:text[level]});
  }
}

/* ===== START ===== */
startBtn.onclick=async()=>{
  if(activated) return;
  activated=true;
  startBtn.style.display="none";

  await Notification.requestPermission();

  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    checkWeather(latitude,longitude);
    setInterval(()=>checkWeather(latitude,longitude),300000);
  },()=>{
    alert("Standort-Zugriff erforderlich");
  });
};
</script>

</body>
</html>


</body>
</html>

