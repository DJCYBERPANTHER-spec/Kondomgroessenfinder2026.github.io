<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>WINTER ALARM</title>
<style>
body { font-family: Arial, sans-serif; background-color: #f0f4f8; color: #333; padding: 20px; }
.alarm { background-color: #ff4d4d; color: white; padding: 20px; margin: 20px 0; border-radius: 10px; font-size: 1.2em; }
.safe { background-color: #4caf50; color: white; padding: 20px; margin: 20px 0; border-radius: 10px; font-size: 1.2em; }
.countdown { font-weight: bold; }
.countdown.green { color: green; }
.countdown.yellow { color: orange; }
.countdown.red { color: red; }
button { padding: 10px 20px; font-size: 1em; margin-top: 10px; margin-right:5px; }
input { padding: 5px; margin-top: 5px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
</style>
</head>
<body>
<h1>WINTER ALARM</h1>

<p>Trage hier deine E-Mail-Adresse(n) ein (mit Komma trennen):</p>
<input type="text" id="emailInput" placeholder="email1@gmail.com,email2@bluewin.ch,email3@outlook.de">
<button id="saveEmails">E-Mail-Adressen speichern</button>
<button id="deleteEmails">E-Mail-Adressen löschen</button>
<p id="emailStatus">Keine E-Mail-Adressen gespeichert.</p>

<p id="status">Bitte tippe auf „Start Alarm“, damit Audio, Notifications und E-Mails aktiviert werden.</p>
<button id="startBtn">Start Alarm</button>
<button id="testBtn">Test-Alarm auslösen</button>
<button id="deleteTestBtn" style="display:none;">Test löschen</button>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxETt5pEIsHFU19u2IL1ouZ_crteiaepipClCflXxjDhDUEvYH_-BaJFBAJQCntdZy_/exec";

let emailList = [];
let currentAlerts = [];
let greenEmailSentToday = false;
let lastStatus = "unknown";
let testActive = false;
let notificationsAllowed = false;
let audioAllowed = false;

const blockedDomains = ["tempmail.com","10minutemail.com","mailinator.com","guerrillamail.com","yopmail.com","fakeinbox.com"];
const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
const loudAlarm = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
loudAlarm.volume = 1.0;

// Hilfsfunktionen
function isValidEmail(email){
  const regex=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if(!regex.test(email)) return false;
  const domain=email.split("@")[1].toLowerCase();
  if(blockedDomains.includes(domain)) return false;
  return true;
}

function formatCountdown(ms){
  if(ms<0) ms=0;
  const h=Math.floor(ms/(1000*60*60));
  const m=Math.floor((ms%(1000*60*60))/(1000*60));
  const s=Math.floor((ms%60000)/1000);
  return {text:`⏳ ${h}h ${m}m ${s}s`, totalMs: ms};
}

// Beim Laden: lokal gespeicherte E-Mails abrufen
window.addEventListener('load', ()=>{
  const savedEmails = localStorage.getItem('winterAlarmEmails');
  if(savedEmails){
    document.getElementById('emailInput').value = savedEmails;
    emailList = savedEmails.split(',').map(e => e.trim()).filter(e => e);
    document.getElementById('emailStatus').textContent = emailList.length>0 ? "Gespeicherte E-Mail-Adressen: "+emailList.join(", ") : "Keine gültigen E-Mail-Adressen gespeichert.";
  }
});

// E-Mail speichern
document.getElementById('saveEmails').addEventListener('click', ()=>{
  const input = document.getElementById('emailInput').value;
  emailList.length = 0;
  const invalid = [];
  input.split(',').forEach(e=>{
    const trimmed=e.trim();
    if(!trimmed) return;
    if(isValidEmail(trimmed)) emailList.push(trimmed);
    else invalid.push(trimmed);
  });
  if(invalid.length>0) alert("❌ Ungültige oder Fake‑E-Mail(s):\n"+invalid.join("\n"));
  localStorage.setItem('winterAlarmEmails', emailList.join(','));
  document.getElementById('emailStatus').textContent = emailList.length>0 ? "Gespeicherte E-Mail-Adressen: "+emailList.join(", ") : "Keine gültigen E-Mail-Adressen gespeichert.";
});

// E-Mail löschen
document.getElementById('deleteEmails').addEventListener('click', ()=>{
  emailList.length = 0;
  document.getElementById('emailInput').value="";
  localStorage.removeItem('winterAlarmEmails');
  document.getElementById('emailStatus').textContent="Keine E-Mail-Adressen gespeichert.";
  alert("Alle E-Mail-Adressen wurden gelöscht!");
});

// Start Button
document.getElementById('startBtn').addEventListener('click', async ()=>{
  if("Notification" in window){
    const permission=await Notification.requestPermission();
    notificationsAllowed=(permission==="granted");
  }
  try{await alarmSound.play(); await alarmSound.pause(); await loudAlarm.play(); await loudAlarm.pause(); audioAllowed=true;}catch(e){}
  document.getElementById('status').innerHTML="✅ WINTER ALARM aktiviert: Audio, Notifications & E-Mails!";
  document.getElementById('startBtn').style.display='none';
  checkWinterAlarm();
  setInterval(updateCountdowns,1000);
  setInterval(checkWinterAlarm,300000); // alle 5 Minuten
  resetGreenEmailDaily();
});

// Wettercheck (Demo: zufällig simuliert, später echte API einsetzen)
async function checkWinterAlarm(){
  try{
    const now = new Date();
    if(Math.random()<0.2){
      currentAlerts = [{start:now,end:new Date(now.getTime()+60*60*1000)}];
    } else currentAlerts = [];
    updateAlarmDisplay();
    if(!testActive) triggerAlarm();
  }catch(e){console.error(e);}
}

// Alarmanzeige & Statusänderung
function updateAlarmDisplay(){
  let alarmMessage="";
  const now=new Date();
  const currentStatus = currentAlerts.length>0 ? "alarm" : "safe";

  if(currentAlerts.length>0){
    alarmMessage=`<div class="alarm">⚠️ WINTER ALARM!</div>`;
    currentAlerts.forEach((p,idx)=>{
      alarmMessage+=`<div class="alarm" id="alert-${idx}">⏱ Zeitraum: ${p.start.toLocaleString()} bis ${p.end.toLocaleString()} <span class="countdown" id="countdown-${idx}"></span></div>`;
    });
    greenEmailSentToday=false;
  } else {
    alarmMessage=`<div class="safe">✅ Kein Sturm/Schnee in den nächsten 48 Stunden</div>`;
    if(lastStatus!=="safe" && emailList.length>0 && !greenEmailSentToday){
      sendGreenEmail();
      greenEmailSentToday=true;
    }
  }

  lastStatus = currentStatus;
  document.getElementById('status').innerHTML=alarmMessage;
}

// Alarm auslösen
function triggerAlarm(){
  const now=new Date();
  currentAlerts.forEach((alert,idx)=>{
    if(alert.start<=now && alert.end>=now){
      sendEmail("alarm");
      if(notificationsAllowed) new Notification("WINTER ALARM",{body:"Sturm/Schnee aktuell!"});
      if(audioAllowed){ loudAlarm.currentTime=0; loudAlarm.play().catch(()=>{}); if(navigator.vibrate) navigator.vibrate([500,200,500,200,500]); }
    }
  });
}

// E-Mail versenden
function sendEmail(type){
  emailList.forEach(to=>{
    const url=`${scriptURL}?to=${encodeURIComponent(to)}&type=${type}`;
    fetch(url).then(resp=>resp.text()).then(txt=>console.log(txt)).catch(e=>console.error(e));
  });
}

// Grüne Erinnerung
function sendGreenEmail(){
  emailList.forEach(to=>{
    const url=`${scriptURL}?to=${encodeURIComponent(to)}&type=green`;
    fetch(url).then(resp=>resp.text()).then(txt=>console.log("Green Email:",txt)).catch(e=>console.error(e));
  });
}

// Countdown aktualisieren
function updateCountdowns(){
  const now=new Date();
  currentAlerts.forEach((alert,idx)=>{
    const countdownEl=document.getElementById(`countdown-${idx}`);
    if(countdownEl){
      const cd = formatCountdown(alert.end-now);
      countdownEl.textContent = cd.text;
      if(cd.totalMs<=60000) countdownEl.className='countdown red';
      else if(cd.totalMs<=120000) countdownEl.className='countdown yellow';
      else countdownEl.className='countdown green';
    }
  });
}

// Test-Alarm
document.getElementById('testBtn').addEventListener('click', ()=>{
  testActive=true;
  const now=new Date();
  currentAlerts.push({start:now,end:new Date(now.getTime()+60000)});
  updateAlarmDisplay();
  triggerAlarm();
  document.getElementById('deleteTestBtn').style.display='inline';
});

document.getElementById('deleteTestBtn').addEventListener('click', ()=>{
  currentAlerts=[];
  testActive=false;
  updateAlarmDisplay();
  document.getElementById('deleteTestBtn').style.display='none';
});

// Mitternacht Reset
function resetGreenEmailDaily(){
  const now = new Date();
  const millisTillMidnight = new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,0)-now;
  setTimeout(function(){
    greenEmailSentToday=false;
    resetGreenEmailDaily();
  }, millisTillMidnight);
}
</script>
</body>
</html>


