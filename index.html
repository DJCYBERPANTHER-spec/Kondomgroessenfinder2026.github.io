<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>CYBER WINTER STURM ALARM SCHWEIZ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#f4f6f8;
  color:#333;
  display:flex;
  flex-direction:column;
  align-items:center;
  min-height:100vh;
}
h1{
  margin:20px 0 10px 0;
  font-size:2rem;
  text-align:center;
}
#ampel{
  margin:10px auto;
  padding:25px 20px;
  width:90%;
  max-width:400px;
  border-radius:15px;
  color:white;
  font-size:1.6rem;
  font-weight:bold;
  text-align:center;
  box-shadow:0 4px 15px rgba(0,0,0,0.2);
}
.green{background:#2ecc71;}
.yellow{background:#f1c40f;color:black;}
.orange{background:#e67e22;}
.red{background:#e74c3c;}
button{
  padding:12px 18px;
  font-size:1.1rem;
  border:none;
  border-radius:12px;
  cursor:pointer;
  margin:5px;
  box-shadow:0 3px 6px rgba(0,0,0,0.15);
  transition:0.2s;
}
button:hover{opacity:0.9;transform:scale(1.02);}
#startBtn{
  padding:18px;
  font-size:1.3rem;
  width:90%;
  max-width:350px;
  background:#3498db;
  color:white;
}
#emailSection{
  margin-top:20px;
  width:90%;
  max-width:400px;
  background:white;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  padding:15px;
}
#emailInput{padding:10px;width:70%;border-radius:8px;border:1px solid #ccc;font-size:1rem;}
.email-item{display:flex;justify-content:space-between;align-items:center;margin:5px 0;padding:5px 10px;background:#f1f1f1;border-radius:8px;}
#countdown,#status{margin-top:15px;font-size:1.1rem;font-weight:500;text-align:center;}
</style>
</head>
<body>

<h1>CYBER WINTER STURM ALARM SCHWEIZ</h1>
<div id="ampel" class="green">Status: Keine Gefahr</div>
<button id="startBtn">Standort aktivieren</button>

<div id="emailSection">
  <h3>E-Mail Benachrichtigungen</h3>
  <div style="display:flex; justify-content:center; margin-bottom:10px;">
    <input id="emailInput" placeholder="E-Mail eingeben">
    <button id="addEmailBtn">âž•</button>
  </div>
  <div id="emailList"></div>
  <button id="testEmailBtn">Test-E-Mail senden</button>
</div>

<div id="status"></div>
<div id="countdown"></div>

<script>
const EMAIL_API="https://script.google.com/macros/s/AKfycbxETt5pEIsHFU19u2IL1ouZ_crteiaepipClCflXxjDhDUEvYH_-BaJFBAJQCntdZy_/exec";

let emails=JSON.parse(localStorage.getItem("emails")||"[]");
let lastLevel=null;
let greenSent=false;

// ================== EMAIL ==================
function renderEmails(){
  const list=document.getElementById("emailList");
  list.innerHTML="";
  emails.forEach((mail,i)=>{
    const div=document.createElement("div");
    div.className="email-item";
    div.textContent=mail;
    const btn=document.createElement("button");
    btn.textContent="ðŸ—‘ï¸";
    btn.addEventListener("click",()=>{
      removeEmail(i);
      alert(`E-Mail ${mail} gelÃ¶scht!`);
    });
    div.appendChild(btn);
    list.appendChild(div);
  });
}
function addEmail(){
  const val=document.getElementById("emailInput").value.trim();
  if(val && !emails.includes(val)){
    emails.push(val);
    localStorage.setItem("emails",JSON.stringify(emails));
    document.getElementById("emailInput").value="";
    renderEmails();
    alert(`E-Mail ${val} hinzugefÃ¼gt!`);
  } else if(!val) alert("Bitte eine E-Mail eingeben!");
  else alert("E-Mail ist schon gespeichert!");
}
function removeEmail(i){
  emails.splice(i,1);
  localStorage.setItem("emails",JSON.stringify(emails));
  renderEmails();
}
document.getElementById("addEmailBtn").addEventListener("click",addEmail);
renderEmails();

// ================== TEST EMAIL ==================
document.getElementById("testEmailBtn").addEventListener("click", ()=>{
  if(emails.length===0){ alert("Keine E-Mails gespeichert!"); return; }
  emails.forEach(e=>{
    fetch(`${EMAIL_API}?to=${encodeURIComponent(e)}&subject=${encodeURIComponent("Cyber Winter Sturm Alarm Test")}&body=${encodeURIComponent("Dies ist eine Test-E-Mail vom Cyber Winter Sturm Alarm. Status: Keine Gefahr")}`)
    .then(res=>res.text())
    .then(()=>console.log(`Test-Mail an ${e} gesendet`))
    .catch(console.error);
  });
  alert("Test-E-Mail sollte gesendet worden sein!");
});

// ================== AMPEL ==================
function getLevel(temp,snow){
  if(temp>=-5 && snow<2) return "green";
  if(temp<-5 && temp>=-10 || snow>=2) return "yellow";
  if(temp<-10 && temp>=-15 || snow>=5) return "orange";
  return "red";
}

// ================== COUNTDOWN ==================
function startCountdown(target){
  clearInterval(window.countdownInterval);
  window.countdownInterval=setInterval(()=>{
    const diff=target-Date.now();
    if(diff<=0){
      document.getElementById("countdown").innerHTML="GEFAHR BEGINNT JETZT!";
      clearInterval(window.countdownInterval);
      return;
    }
    const h=Math.floor(diff/3600000);
    const m=Math.floor(diff%3600000/60000);
    const s=Math.floor(diff%60000/1000);
    document.getElementById("countdown").innerHTML=`Zeit bis Gefahr: ${h}h ${m}m ${s}s`;
  },1000);
}

// ================== EMAIL SENDEN ==================
function sendEmailAll(subject,text){
  emails.forEach(e=>{
    fetch(`${EMAIL_API}?to=${encodeURIComponent(e)}&subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`)
    .then(res=>res.text())
    .then(console.log)
    .catch(console.error);
  });
}

// ================== WETTER ==================
async function checkWeather(lat,lon){
  try{
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,snowfall,time&timezone=Europe/Zurich`;
    const res=await fetch(url);
    if(!res.ok) throw new Error("Fehler beim Abrufen");
    const data=await res.json();

    let minTemp=999,snowSum=0,danger=null;
    for(let i=0;i<28;i++){
      const t=data.hourly.temperature_2m[i];
      const s=data.hourly.snowfall[i];
      minTemp=Math.min(minTemp,t);
      snowSum+=s;
      if(!danger && getLevel(t,s)==="red") danger=new Date(data.hourly.time[i]).getTime();
    }

    const level=getLevel(minTemp,snowSum);
    updateUI(level,minTemp,snowSum);

    if(danger) startCountdown(danger);
    else document.getElementById("countdown").innerHTML="Keine Gefahr in den nÃ¤chsten 28 Stunden";
  }catch(e){
    document.getElementById("status").innerHTML="Fehler beim Laden der Wetterdaten";
    console.error(e);
  }
}

// ================== UI ==================
function updateUI(level,temp,snow){
  const status=document.getElementById("status");
  const ampel=document.getElementById("ampel");
  const txt={green:"Keine Gefahr",yellow:"ErhÃ¶hte Gefahr",orange:"Mittlere Gefahr",red:"Extreme Gefahr â€“ Nicht rausgehen"};
  
  status.innerHTML=`Tiefsttemperatur: ${temp.toFixed(1)}Â°C<br>Schnee: ${snow.toFixed(1)} cm`;
  ampel.className="";
  ampel.classList.add(level);
  ampel.innerText=txt[level];

  if(level!==lastLevel){
    if(emails.length>0){
      let message="";
      if(level==="red") message="Extreme Gefahr â€“ Bitte zuhause bleiben!";
      else if(level==="green" && !greenSent){
        message="Keine Gefahr in den nÃ¤chsten 28 Stunden";
        greenSent=true;
      } else if(level!=="green") greenSent=false;
      else message=`Status geÃ¤ndert: ${txt[level]}`;

      if(message) sendEmailAll("Cyber Winter Sturm Alarm",message);
    }
    lastLevel=level;
  }
}

// ================== START ==================
const startBtn=document.getElementById("startBtn");
startBtn.addEventListener("click",()=>{
  startBtn.style.display="none";
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude,longitude}=pos.coords;
      document.getElementById("status").innerHTML=`Standort erkannt: ${latitude.toFixed(3)}, ${longitude.toFixed(3)}`;
      checkWeather(latitude,longitude);
      setInterval(()=>checkWeather(latitude,longitude),300000);
    },()=>alert("Standort-Zugriff erforderlich"));
  } else alert("Browser unterstÃ¼tzt keinen Standortzugriff!");
});
</script>
</body>
</html>
