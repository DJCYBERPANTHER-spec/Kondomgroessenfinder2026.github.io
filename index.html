<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>CYBER WINTER STURM ALARM SCHWEIZ</title>

<style>
body {
  font-family: Arial, sans-serif;
  background:#eef2f6;
  padding:20px;
  cursor:pointer;
}
h1 { text-align:center; }

.status {
  padding:20px;
  margin-top:15px;
  color:white;
  font-size:1.2em;
  border-radius:10px;
  text-align:center;
}

.green { background:#2ecc71; }
.yellow { background:#f1c40f; color:black; }
.orange { background:#e67e22; }
.red { background:#e74c3c; }

input { padding:6px; width:240px; }
button { padding:6px; margin:4px; }

.email-item {
  margin:5px 0;
}
</style>
</head>

<body>
<h1>CYBER WINTER STURM ALARM SCHWEIZ</h1>
<p><b>Tippe einmal auf den Bildschirm</b>, um Standort & Benachrichtigungen zu aktivieren.</p>

<hr>

<h3>E-Mail Benachrichtigungen</h3>
<input id="emailInput" placeholder="E-Mail eingeben">
<button onclick="addEmail()">‚ûï</button>
<div id="emailList"></div>

<hr>

<div id="output" class="status green">
Noch keine Daten ‚Äì warte auf Standort‚Ä¶
</div>

<script>
let emails = JSON.parse(localStorage.getItem("emails") || "[]");
let lastAmpel = null;
let activated = false;

const alarmSound = new Audio("https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg");
alarmSound.loop = true;

// ---------- EMAILS ----------
function renderEmails(){
  const box = document.getElementById("emailList");
  box.innerHTML = "";
  emails.forEach((mail,i)=>{
    box.innerHTML += `
      <div class="email-item">
        ${mail}
        <button onclick="removeEmail(${i})">üóëÔ∏è</button>
      </div>`;
  });
}
function addEmail(){
  const val = emailInput.value.trim();
  if(val && !emails.includes(val)){
    emails.push(val);
    localStorage.setItem("emails", JSON.stringify(emails));
    emailInput.value="";
    renderEmails();
  }
}
function removeEmail(i){
  emails.splice(i,1);
  localStorage.setItem("emails", JSON.stringify(emails));
  renderEmails();
}
renderEmails();

// ---------- AMPEL LOGIK ----------
function getAmpel(temp, snow){
  if(temp >= -5 && snow < 2) return "green";
  if(temp < -5 && temp >= -10 || snow >= 2) return "yellow";
  if(temp < -10 && temp >= -15 || snow >= 5) return "orange";
  return "red";
}

// ---------- WETTER CHECK ----------
async function checkWeather(lat, lon){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,snowfall&timezone=Europe/Zurich`;
  const res = await fetch(url);
  const data = await res.json();

  let minTemp = Infinity;
  let snowSum = 0;

  for(let i=0;i<28;i++){
    minTemp = Math.min(minTemp, data.hourly.temperature_2m[i]);
    snowSum += data.hourly.snowfall[i];
  }

  const ampel = getAmpel(minTemp, snowSum);
  updateUI(ampel, minTemp, snowSum);
}

// ---------- UI & ALARM ----------
function updateUI(ampel, temp, snow){
  const box = document.getElementById("output");
  box.className = "status " + ampel;

  const text = {
    green: "üü¢ Keine Gefahr in den n√§chsten 28 Stunden",
    yellow: "üü° Erh√∂hte Wintergefahr ‚Äì Vorsicht",
    orange: "üü† Mittlere Gefahr ‚Äì Verkehr eingeschr√§nkt",
    red: "üî¥ EXTREME GEFAHR ‚Äì NICHT RAUSGEHEN"
  };

  box.innerHTML = `
    ${text[ampel]}<br>
    Temperatur min: ${temp.toFixed(1)}¬∞C<br>
    Schnee: ${snow.toFixed(1)} cm
  `;

  if(lastAmpel !== ampel){
    lastAmpel = ampel;

    if(Notification.permission === "granted"){
      new Notification("Winterwarnung", { body: text[ampel] });
    }

    if(ampel === "red"){
      alarmSound.play().catch(()=>{});
      if(navigator.vibrate) navigator.vibrate([800,300,800,300,800]);
    } else {
      alarmSound.pause();
    }
  }
}

// ---------- AKTIVIERUNG (ERSTER KLICK) ----------
document.body.addEventListener("click", ()=>{
  if(activated) return;
  activated = true;

  Notification.requestPermission();

  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    checkWeather(latitude, longitude);
    setInterval(()=>checkWeather(latitude, longitude), 300000);
  }, ()=>{
    alert("Standort wird ben√∂tigt!");
  });
});
</script>
</body>
</html>
