<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>CYBER WINTER STURM ALARM SCHWEIZ</title>
<style>
body { font-family: Arial; background:#f0f4f8; color:#333; padding:20px; cursor:pointer; }
.canton { padding:10px; margin:5px; border-radius:5px; color:white; font-weight:bold; }
.green{background:green;}
.yellow{background:orange;}
.orange{background:darkorange;}
.red{background:red;}
button { margin:3px; padding:5px; }
input { width:250px; padding:5px; }
.countdown { font-weight:bold; }
#emailListContainer div { margin-bottom:5px; }
</style>
</head>
<body>
<h1>CYBER WINTER STURM ALARM SCHWEIZ</h1>
<p>Tippe irgendwo auf die Seite, um Standort & Notifications freizugeben.</p>

<h2>E-Mail-Adressen verwalten</h2>
<input type="text" id="singleEmailInput" placeholder="Neue E-Mail eingeben">
<button id="addEmailBtn">‚ûï Hinzuf√ºgen</button>
<div id="emailListContainer"></div>

<div id="swissMap"></div>
<p id="status"></p>

<button id="testBtn">Test-Alarm ausl√∂sen</button>
<button id="deleteTestBtn" style="display:none;">Test l√∂schen</button>

<script>
const cantons=[
  {code:"ZH",lat:47.378,lon:8.54},{code:"BE",lat:46.948,lon:7.447},{code:"LU",lat:47.051,lon:8.309},
  {code:"UR",lat:46.897,lon:8.631},{code:"SZ",lat:47.020,lon:8.645},{code:"OW",lat:46.893,lon:8.327},
  {code:"NW",lat:46.972,lon:8.305},{code:"GL",lat:46.983,lon:9.066},{code:"ZG",lat:47.152,lon:8.517},
  {code:"FR",lat:46.802,lon:7.154},{code:"SO",lat:47.207,lon:7.537},{code:"BS",lat:47.558,lon:7.588},
  {code:"BL",lat:47.555,lon:7.733},{code:"SH",lat:47.703,lon:8.638},{code:"AR",lat:47.366,lon:9.417},
  {code:"AI",lat:47.366,lon:9.566},{code:"SG",lat:47.424,lon:9.376},{code:"GR",lat:46.859,lon:9.541},
  {code:"AG",lat:47.392,lon:8.045},{code:"TG",lat:47.534,lon:9.059},{code:"TI",lat:46.003,lon:8.955},
  {code:"VD",lat:46.519,lon:6.632},{code:"VS",lat:46.229,lon:7.358},{code:"NE",lat:46.992,lon:6.931},
  {code:"GE",lat:46.204,lon:6.143},{code:"JU",lat:47.351,lon:7.151}
];

let emailList=[];
let firstClickDone=false;
let lastStatusByCanton={};
let testActive=false;
const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
alarmSound.volume=1.0;

// --- E-Mail Verwaltung ---
function loadEmails(){
    const saved = localStorage.getItem('emails');
    emailList = saved ? saved.split(',') : [];
    renderEmailList();
}
function renderEmailList(){
    const container=document.getElementById('emailListContainer');
    container.innerHTML="";
    emailList.forEach((email,index)=>{
        const div=document.createElement('div');
        div.textContent=email+' ';
        const delBtn=document.createElement('button');
        delBtn.textContent='üóëÔ∏è';
        delBtn.addEventListener('click',()=>{
            emailList.splice(index,1);
            localStorage.setItem('emails',emailList.join(','));
            renderEmailList();
        });
        div.appendChild(delBtn);
        container.appendChild(div);
    });
}
document.getElementById('addEmailBtn').addEventListener('click',()=>{
    const input=document.getElementById('singleEmailInput');
    const email=input.value.trim();
    if(email && !emailList.includes(email)){
        emailList.push(email);
        localStorage.setItem('emails',emailList.join(','));
        input.value="";
        renderEmailList();
    } else {
        alert('Ung√ºltige oder bereits vorhandene E-Mail.');
    }
});
loadEmails();

// --- Erstes Tippen ‚Üí Standort & Notifications ---
document.body.addEventListener('click', async ()=>{
    if(firstClickDone) return;
    firstClickDone=true;

    if("Notification" in window){
        const perm = await Notification.requestPermission();
        if(perm==="granted") new Notification("CYBER WINTER STURM ALARM SCHWEIZ aktiviert!");
    }
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>console.log("Standort:",pos.coords.latitude,pos.coords.longitude));
    }

    checkWinterAmpel();
    setInterval(checkWinterAmpel,300000); // alle 5 Minuten
});

// --- Ampellogik ---
function getAmpel(tempMin,snowCm){
  if(tempMin>=-5 && snowCm<2) return "green";
  if((tempMin<-5 && tempMin>=-10) || snowCm>=2) return "yellow";
  if((tempMin<-10 && tempMin>=-15) || snowCm>=5) return "orange";
  if(tempMin<-15 || snowCm>=10) return "red";
  return "green";
}

// --- Wetterdaten abrufen ---
async function checkWinterAmpel(){
    const container=document.getElementById('swissMap');
    container.innerHTML="";
    for(const c of cantons){
        try{
            const url=`https://api.open-meteo.com/v1/forecast?latitude=${c.lat}&longitude=${c.lon}&hourly=temperature_2m,snowfall&timezone=Europe/Zurich`;
            const resp = await fetch(url);
            const data = await resp.json();

            let tempMin=Infinity, snowSum=0;
            for(let i=0;i<28;i++){
                if(data.hourly.temperature_2m[i]<tempMin) tempMin=data.hourly.temperature_2m[i];
                snowSum += data.hourly.snowfall[i];
            }
            const amp=getAmpel(tempMin,snowSum);

            const div=document.createElement('div');
            div.className="canton "+amp;
            div.textContent=`${c.code}: TempMin ${tempMin}¬∞C, Schnee ${snowSum.toFixed(1)}cm ‚Üí ${amp.toUpperCase()}`;
            container.appendChild(div);

            if(lastStatusByCanton[c.code]!==amp){
                lastStatusByCanton[c.code]=amp;
                if(Notification.permission==="granted") new Notification(`CYBER WINTER STURM: ${c.code} ‚Üí ${amp.toUpperCase()}`);
                if(amp==="red"){ alarmSound.currentTime=0; alarmSound.play().catch(()=>{}); if(navigator.vibrate) navigator.vibrate([500,200,500]); }

                // E-Mail senden (Google Script)
                if(emailList.length>0){
                    emailList.forEach(to=>{
                        fetch(`https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?to=${encodeURIComponent(to)}&canton=${c.code}&ampel=${amp}`)
                        .then(r=>r.text()).then(t=>console.log(t)).catch(e=>console.error(e));
                    });
                }
            }

        }catch(e){ console.error("Fehler bei Wetterdaten:",e);}
    }
}

// --- Test-Alarm ---
document.getElementById('testBtn').addEventListener('click', ()=>{
    testActive=true;
    const div=document.createElement("div");
    div.className="canton red";
    div.textContent="TEST ALARM: ROT ‚Äì Alarm aktiv ‚è≥";
    document.getElementById('swissMap').appendChild(div);
    alarmSound.currentTime=0; alarmSound.play();
    if(navigator.vibrate) navigator.vibrate([500,200,500]);
    document.getElementById('deleteTestBtn').style.display='inline';
});
document.getElementById('deleteTestBtn').addEventListener('click', ()=>{
    testActive=false;
    document.getElementById('swissMap').innerHTML="";
    document.getElementById('deleteTestBtn').style.display='none';
    checkWinterAmpel();
});
</script>
</body>
</html>
