<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>CYBER WINTER STURM ALARM SCHWEIZ</title>
<style>
body { font-family: Arial; background:#f0f4f8; color:#333; padding:20px; cursor:pointer; }
.canton { padding:10px; margin:5px; border-radius:5px; color:white; font-weight:bold; }
.green{background:green;}
.yellow{background:orange;}
.orange{background:darkorange;}
.red{background:red;}
button { margin:3px; padding:5px; }
input { width:250px; padding:5px; }
.countdown { font-weight:bold; }
#emailListContainer div { margin-bottom:5px; }
</style>
</head>
<body>
<h1>CYBER WINTER STURM ALARM SCHWEIZ</h1>
<p>Tippe auf die Seite, um Standort & Notifications freizugeben.</p>

<h2>E-Mail-Adressen verwalten</h2>
<input type="text" id="singleEmailInput" placeholder="Neue E-Mail eingeben">
<button id="addEmailBtn">‚ûï Hinzuf√ºgen</button>
<div id="emailListContainer"></div>

<div id="swissMap"></div>
<p id="status"></p>

<button id="testBtn">Test-Alarm ausl√∂sen</button>
<button id="deleteTestBtn" style="display:none;">Test l√∂schen</button>

<script>
let emailList=[];
let firstClickDone=false;
let lastStatusByCanton={};
let testActive=false;
const alarmSound = new Audio('https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg');
alarmSound.volume=1.0;

// --- E-Mail Verwaltung ---
function loadEmails(){
    const saved = localStorage.getItem('emails');
    emailList = saved ? saved.split(',') : [];
    renderEmailList();
}
function renderEmailList(){
    const container=document.getElementById('emailListContainer');
    container.innerHTML="";
    emailList.forEach((email,index)=>{
        const div=document.createElement('div');
        div.textContent=email+' ';
        const delBtn=document.createElement('button');
        delBtn.textContent='üóëÔ∏è';
        delBtn.addEventListener('click',()=>{
            emailList.splice(index,1);
            localStorage.setItem('emails',emailList.join(','));
            renderEmailList();
        });
        div.appendChild(delBtn);
        container.appendChild(div);
    });
}
document.getElementById('addEmailBtn').addEventListener('click',()=>{
    const input=document.getElementById('singleEmailInput');
    const email=input.value.trim();
    if(email && !emailList.includes(email)){
        emailList.push(email);
        localStorage.setItem('emails',emailList.join(','));
        input.value="";
        renderEmailList();
    } else {
        alert('Ung√ºltige oder bereits vorhandene E-Mail.');
    }
});
loadEmails();

// --- Erstes Tippen ‚Üí Standort & Notifications ---
document.body.addEventListener('click', async ()=>{
    if(firstClickDone) return;
    firstClickDone=true;

    if("Notification" in window){
        const perm = await Notification.requestPermission();
        if(perm==="granted") new Notification("CYBER WINTER STURM ALARM SCHWEIZ aktiviert!");
    }

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            console.log("Standort:",pos.coords.latitude,pos.coords.longitude);
            // Nach Standort dynamisch die "Kanton" Simulation erzeugen
            checkWinterAmpel(pos.coords.latitude,pos.coords.longitude);
            setInterval(()=>checkWinterAmpel(pos.coords.latitude,pos.coords.longitude),300000); // alle 5 Min
        }, err=>{
            alert("Standort konnte nicht abgerufen werden.");
            console.error(err);
        });
    } else {
        alert("Dein Browser unterst√ºtzt keine Geolocation.");
    }
});

// --- Ampellogik ---
function getAmpel(tempMin,snowCm){
  if(tempMin>=-5 && snowCm<2) return "green";
  if((tempMin<-5 && tempMin>=-10) || snowCm>=2) return "yellow";
  if((tempMin<-10 && tempMin>=-15) || snowCm>=5) return "orange";
  if(tempMin<-15 || snowCm>=10) return "red";
  return "green";
}

// --- Wetterdaten abrufen anhand Standort ---
async function checkWinterAmpel(lat, lon){
    const container=document.getElementById('swissMap');
    container.innerHTML="";
    try{
        // Prognose 28h
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,snowfall&timezone=Europe/Zurich`;
        const resp = await fetch(url);
        const data = await resp.json();

        let tempMin=Infinity, snowSum=0;
        for(let i=0;i<28;i++){
            if(data.hourly.temperature_2m[i]<tempMin) tempMin=data.hourly.temperature_2m[i];
            snowSum += data.hourly.snowfall[i];
        }
        const amp=getAmpel(tempMin,snowSum);

        const div=document.createElement('div');
        div.className="canton "+amp;
        div.textContent=`Standort: TempMin ${tempMin}¬∞C, Schnee ${snowSum.toFixed(1)}cm ‚Üí ${amp.toUpperCase()}`;
        container.appendChild(div);

        if(lastStatusByCanton['local']!==amp){
            lastStatusByCanton['local']=amp;
            if(Notification.permission==="granted") new Notification(`CYBER WINTER STURM: ${amp.toUpperCase()}`);
            if(amp==="red"){ alarmSound.currentTime=0; alarmSound.play().catch(()=>{}); if(navigator.vibrate) navigator.vibrate([500,200,500]); }

            // E-Mail senden (Google Script)
            if(emailList.length>0){
                emailList.forEach(to=>{
                    fetch(`https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?to=${encodeURIComponent(to)}&ampel=${amp}`)
                    .then(r=>r.text()).then(t=>console.log(t)).catch(e=>console.error(e));
                });
            }
        }
    }catch(e){ console.error("Fehler bei Wetterdaten:",e);}
}

// --- Test-Alarm ---
document.getElementById('testBtn').addEventListener('click', ()=>{
    testActive=true;
    const div=document.createElement("div");
    div.className="canton red";
    div.textContent="TEST ALARM: ROT ‚Äì Alarm aktiv ‚è≥";
    document.getElementById('swissMap').appendChild(div);
    alarmSound.currentTime=0; alarmSound.play();
    if(navigator.vibrate) navigator.vibrate([500,200,500]);
    document.getElementById('deleteTestBtn').style.display='inline';
});
document.getElementById('deleteTestBtn').addEventListener('click', ()=>{
    testActive=false;
    document.getElementById('swissMap').innerHTML="";
    document.getElementById('deleteTestBtn').style.display='none';
});
</script>
</body>
</html>
